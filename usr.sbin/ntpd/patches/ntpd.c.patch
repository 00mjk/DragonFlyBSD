$DragonFly: src/usr.sbin/ntpd/patches/Attic/ntpd.c.patch,v 1.6 2005/04/14 10:31:27 joerg Exp $

--- ntpd.c.orig	2004-11-09 20:39:54.000000000 +0100
+++ ntpd.c	2004-11-09 20:40:48.000000000 +0100
@@ -18,6 +18,7 @@
 
 #include <sys/types.h>
 #include <sys/socket.h>
+#include <sys/sysctl.h>
 #include <sys/wait.h>
 #include <netinet/in.h>
 #include <arpa/inet.h>
@@ -34,7 +35,7 @@
 #include "ntpd.h"
 
 void		sighdlr(int);
-__dead void	usage(void);
+void		usage(void) __dead2;
 int		main(int, char *[]);
 int		check_child(pid_t, const char *);
 int		dispatch_imsg(struct ntpd_conf *);
@@ -63,12 +64,10 @@
 	}
 }
 
-__dead void
+void
 usage(void)
 {
-	extern char *__progname;
-
-	fprintf(stderr, "usage: %s [-dSs] [-f file]\n", __progname);
+	fprintf(stderr, "usage: %s [-dSs] [-f file]\n", getprogname());
 	exit(1);
 }
 
@@ -307,16 +306,18 @@
 void
 ntpd_adjtime(double d)
 {
-	struct timeval	tv;
+	int64_t adjust;
 
 	if (d >= (double)LOG_NEGLIGEE / 1000 ||
 	    d <= -1 * (double)LOG_NEGLIGEE / 1000)
 		log_info("adjusting local clock by %fs", d);
 	else
 		log_debug("adjusting local clock by %fs", d);
-	d_to_tv(d, &tv);
-	if (adjtime(&tv, NULL) == -1)
-		log_warn("adjtime failed");
+	adjust = d * 1e9;
+
+	if (sysctlbyname("kern.ntp.adjust", NULL, NULL, &adjust,
+			 sizeof(adjust)))
+		log_info("adjtime failed");
 }
 
 void
